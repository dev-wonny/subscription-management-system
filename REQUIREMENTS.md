# Requirements Specification

## 1. 프로젝트 목표
구독 기반 비즈니스 모델을 지원하는 관리 시스템을 구축하여, 고객의 구독 생애주기(가입-유지-해지)와 청구/결제를 효율적으로 관리한다.

---

## 2. 핵심 비즈니스 도메인

### 2.1 Plan (플랜/요금제)
- **역할**: 구독 서비스의 상품 카탈로그
- **특징**:
  - 다양한 티어 제공 (Basic, Pro, Enterprise 등)
  - 월간/연간 등 billing cycle 설정 가능
  - 활성/비활성 상태 관리
- **제약사항**:
  - 플랜 삭제 시 기존 구독에 영향 없도록 soft delete 필요 (is_active)

### 2.2 Customer (고객)
- **역할**: 서비스 구독자
- **특징**:
  - 이메일 기반 고유 식별
  - 고객 상태 관리 (ACTIVE, INACTIVE, SUSPENDED)
- **비즈니스 규칙**:
  - 한 고객은 여러 구독을 가질 수 있음 (멀티 라이선스)
  - 고객 삭제 시 연관된 구독/청구내역도 삭제 (GDPR 고려)

### 2.3 Subscription (구독)
- **역할**: 고객과 플랜을 연결하는 계약
- **생애주기**:
  ```
  생성(TRIAL/ACTIVE) → 유지(ACTIVE) → 일시정지(PAUSED) → 해지(CANCELED)
                           ↓
                        플랜변경
  ```
- **핵심 필드**:
  - `next_billing_date`: 다음 청구일 (스케줄러가 참조)
  - `status`: 구독 상태
  - `payment_method_token`: 결제 수단

### 2.4 Invoice (청구 내역)
- **역할**: 구독에 대한 청구서/영수증
- **생성 시점**:
  - 구독 시작 시 첫 Invoice 생성
  - 매월/매년 `next_billing_date` 도래 시 자동 생성 (배치)
- **결제 상태 전이**:
  ```
  PENDING → PAID (결제 성공)
       ↓
    FAILED → PENDING (재시도)
       ↓
  REFUNDED (환불)
  ```

---

## 3. 기능 요구사항

### 3.1 청구 내역 조회 (필수)
**화면명**: 청구 내역 목록  
**구분**: 조회 기능  
**API**: `GET /api/v1/invoices`

**요구사항**:
- [ ] 모든 고객의 청구 내역(invoice)을 리스트로 조회
- [ ] 각 항목은 다음 정보를 표시:
  - 고객 이름 및 이메일
  - 플랜 이름
  - 청구월 (billing_month)
  - 청구 금액 (amount)
  - 결제 상태 (payment_status): PENDING, PAID, FAILED, REFUNDED
  - 결제일 (payment_date)
  - 납부기한 (due_date)
- [ ] 필터링 기능:
  - 청구월 (예: 2024-01)
  - 결제 상태
  - 특정 고객
- [ ] 정렬 기능:
  - 청구일, 납부기한, 결제일 등
- [ ] 페이지네이션 (기본 20개/페이지)

**화면 구성 예시**:
```
┌─────────────────────────────────────────────────────────────────┐
│ 청구 내역 목록                                    [필터] [검색]   │
├─────────────────────────────────────────────────────────────────┤
│ 고객명     │ 플랜    │ 청구월   │ 금액     │ 상태    │ 납부기한  │
├─────────────────────────────────────────────────────────────────┤
│ 김철수     │ Pro     │ 2024-02  │ 19,900원 │ PENDING │ 2024-02-29│
│ 이영희     │ Basic   │ 2024-02  │  9,900원 │ PAID    │ 2024-02-29│
│ 박민수     │ Enterprise│ 2024-02│ 49,900원 │ PAID    │ 2024-02-29│
└─────────────────────────────────────────────────────────────────┘
                      [1] 2 3 4 5 ... 10
```

**검증 포인트**:
- 데이터 정합성: invoice의 customer_id와 실제 고객 정보 일치
- 성능: 대량 데이터 조회 시 페이지네이션 동작
- 필터링 정확도: 복수 필터 조합 시 AND 조건 적용

---

### 3.2 구독 추가 (필수)
**화면명**: 구독 추가 팝업  
**구분**: 추가 기능  
**API**: `POST /api/v1/subscriptions/add`

**요구사항**:
- [ ] 팝업/모달 형태로 구독 추가 폼 제공
- [ ] 입력 필드:
  - 고객 선택 (드롭다운 또는 자동완성)
  - 플랜 선택 (활성화된 플랜만)
  - 시작일 (날짜 선택기)
  - 결제 수단 (옵션)
  - 초기 상태 (TRIAL/ACTIVE 선택, 기본값: ACTIVE)
- [ ] 유효성 검증:
  - 고객과 플랜은 필수 선택
  - 시작일은 과거 또는 오늘 날짜만 가능
  - 플랜이 비활성화된 경우 에러 메시지
- [ ] 저장 성공 시:
  - 첫 번째 Invoice 자동 생성 (TRIAL 제외)
  - 성공 메시지 표시
  - 구독 목록 화면으로 이동 또는 팝업 닫기

**화면 구성 예시**:
```
┌─────────────────────────────────────┐
│ 구독 추가                      [X]  │
├─────────────────────────────────────┤
│ 고객:      [김철수 ▼]              │
│ 플랜:      [Pro ▼]                 │
│ 시작일:    [2024-02-01 📅]         │
│ 결제수단:  [tok_visa_1234]         │
│ 상태:      ○ ACTIVE  ○ TRIAL      │
│                                     │
│         [취소]      [저장]          │
└─────────────────────────────────────┘
```

**검증 포인트**:
- 트랜잭션 처리: Subscription + Invoice 동시 생성
- `next_billing_date` 자동 계산 정확도
- 비활성 플랜 선택 시 에러 핸들링

---

### 3.3 구독 수정 (필수)
**화면명**: 구독 내역 수정 팝업  
**구분**: 수정 기능  
**API**: `POST /api/v1/subscriptions/modify`

**요구사항**:
- [ ] 팝업/모달 형태로 구독 수정 폼 제공
- [ ] 기존 구독 정보 미리 채우기 (Pre-fill)
- [ ] 수정 가능 필드:
  - 플랜 변경 (업그레이드/다운그레이드)
  - 결제 수단 변경
  - 상태 변경 (ACTIVE ↔ PAUSED, CANCELED)
- [ ] 플랜 변경 시:
  - 즉시 적용 (Immediate)
  - 차액 정산 안내 메시지
  - 예: "Pro → Enterprise 변경 시 30,000원 추가 청구됩니다"
- [ ] 해지(CANCELED) 처리 시:
  - 해지일(end_date) 필수 입력
  - 확인 다이얼로그: "정말 해지하시겠습니까?"
  - 해지 후 `next_billing_date` null 처리
- [ ] 일시정지(PAUSED) 처리 시:
  - 다음 청구 건너뛰기
  - 재활성화 가능 안내

**화면 구성 예시**:
```
┌─────────────────────────────────────┐
│ 구독 수정                      [X]  │
├─────────────────────────────────────┤
│ 고객:      김철수 (변경불가)        │
│ 현재 플랜:  Pro → [Enterprise ▼]   │
│ 시작일:    2024-02-01 (변경불가)   │
│ 결제수단:  [tok_visa_5678]         │
│ 상태:      ○ ACTIVE  ○ PAUSED     │
│            ○ CANCELED              │
│ 해지일:    [2024-12-31 📅]         │
│                                     │
│ ⚠️ 플랜 변경 시 30,000원 추가       │
│                                     │
│         [취소]      [저장]          │
└─────────────────────────────────────┘
```

**검증 포인트**:
- 해지된 구독은 수정 불가 에러 처리
- 플랜 변경 시 차액 정산 Invoice 생성
- 상태 전이 유효성 (예: CANCELED → ACTIVE 불가)

---

## 4. 비기능 요구사항

### 4.1 성능
- [ ] 청구 내역 조회: 1,000건 기준 1초 이내 응답
- [ ] 구독 추가/수정: 300ms 이내 처리
- [ ] DB 인덱스 최적화: customer_id, plan_id, billing_month, payment_status

### 4.2 보안
- [ ] SQL Injection 방어 (Parameterized Query 사용)
- [ ] XSS 방어 (입력값 sanitization)
- [ ] `payment_method_token`은 암호화 저장 (선택)

### 4.3 확장성
- [ ] 추후 배치 스케줄러 추가 고려 (청구서 자동 생성)
- [ ] PG사 연동을 위한 Webhook 수신 엔드포인트 확장 가능

### 4.4 사용성
- [ ] 반응형 UI (모바일/데스크톱)
- [ ] 로딩 인디케이터
- [ ] 에러 메시지 사용자 친화적 표시
- [ ] 날짜 입력: DatePicker 제공

---

## 5. 데이터 유효성 규칙

### 5.1 Subscription
- `start_date` ≤ TODAY
- `end_date` > `start_date` (if exists)
- `next_billing_date` > `start_date`
- `status` ∈ {ACTIVE, CANCELED, TRIAL, PAUSED}

### 5.2 Invoice
- `amount` ≥ 0
- `payment_status` ∈ {PENDING, PAID, FAILED, REFUNDED}
- `billing_month` format: YYYY-MM
- `due_date` ≥ `issued_at`

### 5.3 Customer
- `email`: 이메일 형식 검증 (RFC 5322)
- `phone`: 선택 입력, 형식 검증 (010-XXXX-XXXX)

---

## 6. 역기획 검증 포인트

데이터베이스 스키마를 기반으로 다음을 확인:

### 6.1 화면 구성 적절성
- [ ] Invoice 조회 시 JOIN 쿼리로 고객/플랜 정보 함께 표시 가능한가?
- [ ] Subscription 추가/수정 화면에서 필요한 데이터를 모두 입력받는가?

### 6.2 데이터 흐름
- [ ] 구독 추가 → Invoice 생성 로직이 자연스러운가?
- [ ] 플랜 변경 → 차액 정산 Invoice 생성 로직이 명확한가?

### 6.3 비즈니스 규칙 반영
- [ ] `next_billing_date` 계산 로직이 구현 가능한가?
- [ ] 구독 상태 전이가 DB 제약사항과 충돌하지 않는가?

### 6.4 확장 가능성
- [ ] 추후 할인/쿠폰 기능 추가 시 Invoice 구조가 충분한가?
- [ ] 다중 결제 수단 지원 시 확장 가능한가?

---

## 7. 개발 체크리스트

### Phase 1: Backend (Node.js + Express)
- [ ] PostgreSQL 연결 설정 (pg 라이브러리)
- [ ] 테이블 생성 마이그레이션 스크립트
- [ ] 샘플 데이터 Seed 스크립트
- [ ] `/api/v1/invoices` GET 구현
- [ ] `/api/v1/subscriptions/add` POST 구현
- [ ] `/api/v1/subscriptions/modify` POST 구현
- [ ] 에러 핸들링 미들웨어
- [ ] 로깅 (morgan 또는 winston)

### Phase 2: Frontend (React 추천)
- [ ] 청구 내역 목록 페이지
- [ ] 구독 추가 모달/팝업
- [ ] 구독 수정 모달/팝업
- [ ] 필터/정렬/페이지네이션 UI
- [ ] API 호출 (axios 또는 fetch)
- [ ] 에러 토스트/알림

### Phase 3: 통합 & 배포
- [ ] Frontend-Backend 연동 테스트
- [ ] 시연 시나리오 작성
- [ ] 시연 영상 녹화
- [ ] README 작성 (실행 방법)
- [ ] 배포 (Heroku, Vercel 등)

---

## 8. 시연 시나리오 (추천)

1. **청구 내역 조회**
   - 전체 목록 확인
   - 결제 상태 필터링 (PENDING)
   - 특정 고객 검색

2. **구독 추가**
   - 신규 고객에게 Basic 플랜 구독
   - Invoice 자동 생성 확인

3. **구독 수정**
   - Basic → Pro 플랜 업그레이드
   - 차액 정산 확인
   - 구독 일시정지 → 재활성화
   - 구독 해지 (CANCELED)

4. **데이터 정합성 확인**
   - 해지된 구독의 Invoice 상태 확인
   - `next_billing_date` 갱신 확인